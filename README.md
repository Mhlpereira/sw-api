
# Star Wars API Gateway

Uma API constru√≠da com FastAPI, que consome dados da API p√∫blica do swapi.info. O sistema utiliza Redis para cache eficiente, reduzindo a lat√™ncia e a carga sobre a API original. Implementa resolu√ß√£o inteligente de URLs, convertendo links brutos em nomes leg√≠veis e informativos.

O deploy foi realizado na AWS utilizando Lambda Functions com API Gateway. O Redis est√° hospedado em uma inst√¢ncia EC2 dedicada, separando a camada de cache para melhor desempenho e controle.

A aplica√ß√£o utiliza Mangum como adapter para executar FastAPI em ambiente serverless AWS Lambda. O sistema implementa controle de concorr√™ncia com sem√°foros e retry autom√°tico com Tenacity para garantir robustez na integra√ß√£o com APIs externas.

## üß≠ Como Usar
Para come√ßar a utilizar a API, siga os passos abaixo:

### 1. üî• Fa√ßa o Warm-Up do Cache (opcional)
Antes de realizar consultas, √© recomend√°vel popular o cache com todos os dados da SWAPI para garantir desempenho m√°ximo e respostas leg√≠veis com nomes em vez de URLs.

```bash
curl -X POST https://qy5sfbks3c.execute-api.us-east-1.amazonaws.com/deploy/swapi-function/warm-cache
```

Esse processo:
- Pr√©-carrega os dados da API p√∫blica no Redis
- Resolve automaticamente as URLs em nomes leg√≠veis
- Reduz significativamente a lat√™ncia das pr√≥ximas requisi√ß√µes

### 2. üîê Gere um Token de Autentica√ß√£o (JWT)
A maioria dos endpoints requer autentica√ß√£o. Para isso, gere um token JWT:

```bash
curl -X POST https://qy5sfbks3c.execute-api.us-east-1.amazonaws.com/deploy/swapi-function/auth
```

Resposta:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### 3. üì° Fa√ßa Requisi√ß√µes Autenticadas
Agora que voc√™ tem um token JWT, use-o no header Authorization das suas requisi√ß√µes:

```bash
curl -H "Authorization: Bearer <seu_token>" https://qy5sfbks3c.execute-api.us-east-1.amazonaws.com/deploy/swapi-function/swapi/people
```

### 4. üîÑ Resultado com Resolu√ß√£o de Nomes
Gra√ßas ao warm-up e √† l√≥gica de cache inteligente, a resposta da API j√° vir√° com nomes resolvidos:

```json
{
  "name": "Luke Skywalker",
  "homeworld": "Tatooine",
  "films": ["A New Hope"]
}
```

## üåê Acesso via API Gateway

**Base URL**: `https://qy5sfbks3c.execute-api.us-east-1.amazonaws.com/deploy/swapi-function`

A API est√° dispon√≠vel atrav√©s do AWS API Gateway que invoca uma Lambda Function.

## üèóÔ∏è Arquitetura

- **Frontend**: AWS API Gateway
- **Backend**: FastAPI + Mangum (Python 3.10+)
- **Compute**: AWS Lambda Function
- **Cache**: Redis (EC2 instance)
- **Fonte de Dados**: SWAPI P√∫blica (swapi.info)

### Componentes T√©cnicos

- **Mangum**: Adapter que permite executar aplica√ß√µes FastAPI em AWS Lambda
- **Sem√°foro**: Controla concorr√™ncia para evitar sobrecarga na API externa
- **Tenacity**: Implementa retry autom√°tico com backoff exponencial para requests HTTP

## üöÄ Funcionalidades Principais

### ‚úÖ Consumo da API P√∫blica SWAPI
- Integra√ß√£o completa com a API oficial do Star Wars
- Dados em tempo real de pessoas, filmes, naves, ve√≠culos, esp√©cies e planetas
- Sistema de fallback para garantir disponibilidade

### ‚úÖ Sistema de Cache Inteligente
- **Redis** hospedado em EC2 na AWS para performance m√°xima
- Cache autom√°tico de todas as consultas
- Resolu√ß√£o de URLs para nomes (ex: `https://swapi.info/api/planets/1` ‚Üí `"Tatooine"`)
- TTL configur√°vel para otimizar recursos

### ‚úÖ Autentica√ß√£o JWT
- Tokens seguros com expira√ß√£o configur√°vel
- Prote√ß√£o de endpoints sens√≠veis
- Middleware de autentica√ß√£o robusto

## üîß Configura√ß√£o Local (Desenvolvimento)

### Pr√©-requisitos
- **Python 3.10+**
- **Poetry** (gerenciamento de depend√™ncias)
- **Docker** (para Redis local)

### Instala√ß√£o
```bash
# 1. Clone o reposit√≥rio
git clone <url-do-repositorio>
cd starwars_api

# 2. Instale depend√™ncias
poetry install

# 3. Configure vari√°veis de ambiente
cp .env.example .env

# 4. Inicie Redis local
docker compose up -d

# 5. Execute a aplica√ß√£o
poetry run uvicorn src.starwars_api.main:app --host 0.0.0.0 --port 8000 --reload
```

## üîê Autentica√ß√£o

### 1. Gerar Bearer Token

Fa√ßa uma requisi√ß√£o POST para obter o token JWT:

```bash
curl -X POST https://qy5sfbks3c.execute-api.us-east-1.amazonaws.com/deploy/swapi-function/auth
```

**Resposta:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### 2. Usar o Token

Inclua o token no header `Authorization` de todas as requisi√ß√µes para endpoints protegidos:

```bash
curl -H "Authorization: Bearer <seu_token>" https://qy5sfbks3c.execute-api.us-east-1.amazonaws.com/deploy/swapi-function/swapi/people
```

## üîó Endpoints Dispon√≠veis

### üè• Monitoramento
- `GET /health` - Health check da aplica√ß√£o

### üîê Autentica√ß√£o
- `POST /auth` - Gerar token JWT
- `POST /warm-cache` - Popular cache Redis (recomendado ap√≥s deploy)

### üìä SWAPI Endpoints (requerem autentica√ß√£o)

#### Pessoas
- `GET /swapi/people` - Listar todas as pessoas
- `GET /swapi/people/{id}` - Obter pessoa espec√≠fica

#### Filmes
- `GET /swapi/films` - Listar todos os filmes
- `GET /swapi/films/{id}` - Obter filme espec√≠fico

#### Naves Estelares
- `GET /swapi/starships` - Listar todas as naves
- `GET /swapi/starships/{id}` - Obter nave espec√≠fica

#### Ve√≠culos
- `GET /swapi/vehicles` - Listar todos os ve√≠culos
- `GET /swapi/vehicles/{id}` - Obter ve√≠culo espec√≠fico

#### Esp√©cies
- `GET /swapi/species` - Listar todas as esp√©cies
- `GET /swapi/species/{id}` - Obter esp√©cie espec√≠fica

#### Planetas
- `GET /swapi/planets` - Listar todos os planetas
- `GET /swapi/planets/{id}` - Obter planeta espec√≠fico

## üîç Filtros e Ordena√ß√£o

### Filtros Dispon√≠veis

Todos os endpoints suportam filtros espec√≠ficos para consultas precisas:

**Exemplos:**
```bash
# Filtrar pessoas por nome
GET /swapi/people?name=Luke

# Filtrar filmes por diretor
GET /swapi/films?director=Lucas

# Filtrar naves por classe
GET /swapi/starships?starship_class=Starfighter

# M√∫ltiplos filtros
GET /swapi/people?name=Luke&eye_color=blue
```

### Ordena√ß√£o

Todos os endpoints suportam ordena√ß√£o por qualquer campo:

```bash
# Ordenar filmes por t√≠tulo (crescente)
GET /swapi/films?order=asc&order_by=title

# Ordenar pessoas por altura (decrescente)
GET /swapi/people?order=desc&order_by=height

# Ordenar planetas por popula√ß√£o
GET /swapi/planets?order=desc&order_by=population
```

## üíæ Sistema de Cache Redis

### Estrat√©gia de Cache

O sistema utiliza **Redis** hospedado em EC2 na AWS para otimizar performance:

#### üöÄ Warm-up do Cache (Recomendado)
```bash
# Popular cache com todos os dados da SWAPI
curl -X POST https://qy5sfbks3c.execute-api.us-east-1.amazonaws.com/deploy/swapi-function/warm-cache
```

**Benef√≠cios:**
- Cache pr√©-populado com todos os dados
- Resolu√ß√£o pr√©via de URLs para nomes
- Consultas subsequentes instant√¢neas
- Redu√ß√£o de lat√™ncia significativa

#### üîÑ Cache Autom√°tico
Se n√£o usar o warm-up, o cache √© populado automaticamente:
- Primeira consulta: busca da SWAPI p√∫blica + cache
- Consultas seguintes: resposta instant√¢nea do cache
- URLs s√£o resolvidas e cacheadas automaticamente

### Resolu√ß√£o de URLs para Nomes

O sistema converte automaticamente URLs da SWAPI para nomes leg√≠veis:

```json
// Antes
{
  "name": "Luke Skywalker",
  "homeworld": "https://swapi.info/api/planets/1",
  "films": ["https://swapi.info/api/films/1"]
}

// Depois
{
  "name": "Luke Skywalker",
  "homeworld": "Tatooine",
  "films": ["A New Hope"]
}
```

## üè• Health Check

Monitore a sa√∫de da aplica√ß√£o:

```bash
GET /health
```

**Resposta:**
```json
{
  "status": "ready"
}
```

### Fluxo de Dados

```
Cliente ‚Üí AWS API Gateway ‚Üí Lambda Function ‚Üí Redis (EC2)
                                ‚Üì
                           SWAPI.info
```

1. **Cliente** faz requisi√ß√£o via AWS API Gateway
2. **API Gateway** roteia para Lambda Function
3. **Lambda Function** (FastAPI + Mangum) verifica cache no Redis
4. Se n√£o cached: busca na **SWAPI p√∫blica** com retry autom√°tico
5. **Redis** armazena resultado para consultas futuras
6. **Resposta** retorna via API Gateway

## ‚öôÔ∏è Componentes T√©cnicos

### Mangum
Adapter que permite executar aplica√ß√µes ASGI (FastAPI) em AWS Lambda Functions, convertendo eventos Lambda para requisi√ß√µes HTTP.

### Sem√°foro (asyncio.Semaphore)
Controla a concorr√™ncia limitando o n√∫mero de requisi√ß√µes simult√¢neas para a API externa, evitando sobrecarga e rate limits.

### Tenacity
Implementa retry autom√°tico com backoff exponencial para requisi√ß√µes HTTP que falham, garantindo maior robustez na integra√ß√£o com APIs externas.

## ‚öôÔ∏è Configura√ß√£o de Ambiente

### Vari√°veis de Ambiente

```bash
# Redis Local
REDIS_URL="redis://localhost:6379"

# JWT Secret Key
JWT_SECRET_KEY=your_secure_secret_key_here

# SWAPI Base URL
SWAPI_BASE_URL="https://swapi.info/api"
```

## üê≥ Desenvolvimento Local

### Executar com Docker:
```bash
# Iniciar Redis local
docker compose up -d

# Verificar status
docker compose ps

# Executar aplica√ß√£o
poetry run uvicorn src.starwars_api.main:app --host 0.0.0.0 --port 8000 --reload
```

## üß™ Testes

### Executar todos os testes:
```bash
poetry run pytest
```

### Testes espec√≠ficos:
```bash
# Testes de rotas
poetry run pytest tests/test_routes.py -v

# Testes de servi√ßos
poetry run pytest tests/test_swapi_service.py -v

# Testes de autentica√ß√£o
poetry run pytest tests/test_auth_service.py -v
```

## üìö Documenta√ß√£o

### Swagger UI
```
https://qy5sfbks3c.execute-api.us-east-1.amazonaws.com/deploy/swapi-function/docs
```

### Desenvolvimento Local
```
http://localhost:8000/docs
```

## üõ†Ô∏è Estrutura do Projeto

```
starwars_api/
‚îú‚îÄ‚îÄ src/starwars_api/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                 # Aplica√ß√£o FastAPI principal
‚îÇ   ‚îú‚îÄ‚îÄ cache/                  # Sistema de cache Redis
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache.py           # Interface do cache
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache_instance.py  # Inst√¢ncia Redis
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ warmup_service.py  # Servi√ßo de warm-up
‚îÇ   ‚îú‚îÄ‚îÄ routes/                 # Rotas da API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_router.py     # Endpoints de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ swapi_router.py    # Endpoints SWAPI
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/               # Data Transfer Objects
‚îÇ   ‚îú‚îÄ‚îÄ services/               # L√≥gica de neg√≥cio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_service.py    # Servi√ßo de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ swapi_service.py   # Servi√ßo SWAPI
‚îÇ   ‚îú‚îÄ‚îÄ util/                   # Utilit√°rios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ naming.py          # Resolu√ß√£o de nomes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sorting.py         # Ordena√ß√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ resolve_name_fields.py # Resolu√ß√£o de campos
‚îÇ   ‚îî‚îÄ‚îÄ enums/                  # Enumera√ß√µes
‚îÇ       ‚îî‚îÄ‚îÄ order_enum.py      # Enum de ordena√ß√£o
‚îú‚îÄ‚îÄ tests/                      # Testes automatizados
‚îú‚îÄ‚îÄ docker-compose.yml          # Configura√ß√£o Redis local
‚îú‚îÄ‚îÄ Dockerfile                  # Container da aplica√ß√£o
‚îî‚îÄ‚îÄ pyproject.toml             # Configura√ß√£o Poetry
```
