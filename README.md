
# Star Wars API Gateway

Uma API constru√≠da com FastAPI, que consome dados da API p√∫blica do swapi.info. O sistema utiliza Redis para cache eficiente, reduzindo a lat√™ncia e a carga sobre a API original. Implementa resolu√ß√£o inteligente de URLs, convertendo links brutos em nomes leg√≠veis e informativos.

O deploy foi realizado no Cloud Run (GCP), garantindo escalabilidade autom√°tica e baixo custo operacional. O Redis est√° hospedado em uma VM dedicada, separando a camada de cache para melhor desempenho e controle.

Um gateway foi implementado como camada intermedi√°ria entre os clientes e os servi√ßos internos, permitindo maior seguran√ßa, centraliza√ß√£o de autentica√ß√£o com JWT, controle de tr√°fego e f√°cil aplica√ß√£o de pol√≠ticas de rate limit e logging.

## üß≠ Como Usar
Para come√ßar a utilizar a API, siga os passos abaixo:

1. üî• Fa√ßa o Warm-Up do Cache
Antes de realizar consultas, √© recomend√°vel popular o cache com todos os dados da SWAPI para garantir desempenho m√°ximo e respostas leg√≠veis com nomes em vez de URLs.

```

curl -X POST https://swapi-gateway-9gaiurpg.uc.gateway.dev/warm-cache
```

Esse processo:

Pr√©-carrega os dados da API p√∫blica no Redis

Resolve automaticamente as URLs em nomes leg√≠veis

Reduz significativamente a lat√™ncia das pr√≥ximas requisi√ß√µes

2. üîê Gere um Token de Autentica√ß√£o (JWT)
A maioria dos endpoints requer autentica√ß√£o. Para isso, gere um token JWT:

```

curl -X POST https://swapi-gateway-9gaiurpg.uc.gateway.dev/auth
```

Resposta:

```

{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

Copie o valor do access_token.

3. üì° Fa√ßa Requisi√ß√µes Autenticadas
Agora que voc√™ tem um token JWT, use-o no header Authorization das suas requisi√ß√µes:
```
curl -H "Authorization: Bearer <seu_token>" https://swapi-gateway-9gaiurpg.uc.gateway.dev/swapi/people
Voc√™ pode acessar qualquer endpoint da API (pessoas, filmes, planetas etc.) da mesma forma, sempre com o token no header.
```

4. üîÑ Resultado com Resolu√ß√£o de Nomes
Gra√ßas ao warm-up e √† l√≥gica de cache inteligente, a resposta da API j√° vir√° com nomes resolvidos, como:
```
{
  "name": "Luke Skywalker",
  "homeworld": "Tatooine",
  "films": ["A New Hope"]
}
```

## üåê Acesso via API Gateway

**Base URL**: `https://swapi-gateway-9gaiurpg.uc.gateway.dev`

A API est√° dispon√≠vel atrav√©s do Google Cloud API Gateway e pode ser acessada diretamente pelos endpoints p√∫blicos configurados.

## üèóÔ∏è Arquitetura

- **Frontend**: API Gateway (GCP)
- **Backend**: FastAPI (Python 3.10+)
- **Hospedagem**: Cloud Run (GCP)
- **Cache**: Redis (VM no GCP)
- **Containeriza√ß√£o**: Docker
- **Fonte de Dados**: SWAPI P√∫blica (swapi.info)

## üöÄ Funcionalidades Principais

### ‚úÖ Consumo da API P√∫blica SWAPI
- Integra√ß√£o completa com a API oficial do Star Wars
- Dados em tempo real de pessoas, filmes, naves, ve√≠culos, esp√©cies e planetas
- Sistema de fallback para garantir disponibilidade

### ‚úÖ Sistema de Cache Inteligente
- **Redis** hospedado em VM no GCP para performance m√°xima
- Cache autom√°tico de todas as consultas
- Resolu√ß√£o de URLs para nomes (ex: `https://swapi.info/api/planets/1` ‚Üí `"Tatooine"`)
- TTL configur√°vel para otimizar recursos

### ‚úÖ Autentica√ß√£o JWT
- Tokens seguros com expira√ß√£o configur√°vel
- Prote√ß√£o de endpoints sens√≠veis
- Middleware de autentica√ß√£o robusto

## üîß Configura√ß√£o Local (Desenvolvimento)

### Pr√©-requisitos
- **Python 3.10+**
- **Poetry** (gerenciamento de depend√™ncias)
- **Docker** (para Redis local)

### Instala√ß√£o
```bash
# 1. Clone o reposit√≥rio
git clone <url-do-repositorio>
cd starwars_api

# 2. Instale depend√™ncias
poetry install

# 3. Configure vari√°veis de ambiente
cp .env.example .env

# 4. Inicie Redis local
docker compose up -d

# 5. Execute a aplica√ß√£o
poetry run uvicorn src.starwars_api.main:app --host 0.0.0.0 --port 8000 --reload
```

## üîê Autentica√ß√£o

### 1. Gerar Bearer Token

Fa√ßa uma requisi√ß√£o POST atrav√©s do API Gateway para obter o token JWT:

```bash
curl -X POST https://swapi-gateway-9gaiurpg.uc.gateway.dev/auth
```

**Resposta:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### 2. Usar o Token

Inclua o token no header `Authorization` de todas as requisi√ß√µes para endpoints protegidos:

```bash
curl -H "Authorization: Bearer <seu_token>" https://swapi-gateway-9gaiurpg.uc.gateway.dev/swapi/people
```

## üîó Endpoints do API Gateway

### üè• Monitoramento
- `GET /health` - Health check da aplica√ß√£o

### üîê Autentica√ß√£o
- `POST /auth` - Gerar token JWT
- `POST /warm-cache` - Popular cache Redis (recomendado ap√≥s deploy)

### üìä SWAPI Endpoints (requerem autentica√ß√£o)

#### Pessoas
- `GET /swapi/people` - Listar todas as pessoas
- `GET /swapi/people/{id}` - Obter pessoa espec√≠fica

#### Filmes
- `GET /swapi/films` - Listar todos os filmes
- `GET /swapi/films/{id}` - Obter filme espec√≠fico

#### Naves Estelares
- `GET /swapi/starships` - Listar todas as naves
- `GET /swapi/starships/{id}` - Obter nave espec√≠fica

#### Ve√≠culos
- `GET /swapi/vehicles` - Listar todos os ve√≠culos
- `GET /swapi/vehicles/{id}` - Obter ve√≠culo espec√≠fico

#### Esp√©cies
- `GET /swapi/species` - Listar todas as esp√©cies
- `GET /swapi/species/{id}` - Obter esp√©cie espec√≠fica

#### Planetas
- `GET /swapi/planets` - Listar todos os planetas
- `GET /swapi/planets/{id}` - Obter planeta espec√≠fico

## üîç Filtros e Ordena√ß√£o

### Filtros Dispon√≠veis

Todos os endpoints suportam filtros espec√≠ficos para consultas precisas:

**Exemplos de Filtros:**
```bash
# Filtrar pessoas por nome
GET /swapi/people?name=Luke

# Filtrar filmes por diretor
GET /swapi/films?director=Lucas

# Filtrar naves por classe
GET /swapi/starships?starship_class=Starfighter

# M√∫ltiplos filtros
GET /swapi/people?name=Luke&eye_color=blue
```

### Ordena√ß√£o Inteligente

Todos os endpoints suportam ordena√ß√£o por qualquer campo:

```bash
# Ordenar filmes por t√≠tulo (crescente)
GET /swapi/films?order=asc&order_by=title

# Ordenar pessoas por altura (decrescente)
GET /swapi/people?order=desc&order_by=height

# Ordenar planetas por popula√ß√£o
GET /swapi/planets?order=desc&order_by=population
```

**Campos orden√°veis comuns:**
- `name` (pessoas, esp√©cies, planetas, naves, ve√≠culos)
- `title` (filmes)
- `height`, `mass` (pessoas)
- `release_date`, `episode_id` (filmes)
- `length`, `cost_in_credits` (naves, ve√≠culos)

## üíæ Sistema de Cache Redis

### Estrat√©gia de Cache Inteligente

O sistema utiliza **Redis** hospedado em VM no GCP para otimizar performance:

#### üöÄ Warm-up do Cache (Recomendado)
```bash
# Popular cache com todos os dados da SWAPI
curl -X POST https://swapi-gateway-9gaiurpg.uc.gateway.dev/warm-cache
```

**Benef√≠cios do warm-up:**
- Cache pr√©-populado com todos os dados
- Resolu√ß√£o pr√©via de URLs para nomes
- Consultas subsequentes instant√¢neas
- Redu√ß√£o de lat√™ncia em 90%

#### üîÑ Cache Autom√°tico
Se n√£o usar o warm-up, o cache √© populado automaticamente:
- Primeira consulta: busca da SWAPI p√∫blica + cache
- Consultas seguintes: resposta instant√¢nea do cache
- URLs s√£o resolvidas e cacheadas automaticamente

### Resolu√ß√£o de URLs para Nomes

O sistema converte automaticamente URLs da SWAPI para nomes leg√≠veis:

**Exemplo pr√°tico:**
```bash
# Consulta inicial retorna URLs
GET /swapi/people/1
{
  "name": "Luke Skywalker",
  "homeworld": "https://swapi.info/api/planets/1",
  "films": ["https://swapi.info/api/films/1"]
}

# Ap√≥s processamento (autom√°tico)
{
  "name": "Luke Skywalker",
  "homeworld": "Tatooine",
  "films": ["A New Hope"]
}
```

## üè• Health Check

Monitore a sa√∫de da aplica√ß√£o:

```bash
GET /health
```

**Resposta:**
```json
{
  "status": "ready"
}
```

Este endpoint verifica:
- Status da aplica√ß√£o FastAPI
- Conectividade com Redis
- Disponibilidade da SWAPI p√∫blica

## üåê Infraestrutura GCP

### Componentes da Arquitetura

#### üö™ API Gateway
- **Fun√ß√£o**: Ponto de entrada √∫nico para todas as requisi√ß√µes
- **Benef√≠cios**: Rate limiting, autentica√ß√£o, logging, monitoramento
- **Configura√ß√£o**: Swagger/OpenAPI 2.0

#### üèÉ‚Äç‚ôÇÔ∏è Cloud Run
- **Fun√ß√£o**: Hospedagem da aplica√ß√£o FastAPI
- **Benef√≠cios**: Escalabilidade autom√°tica, serverless, pay-per-use
- **Configura√ß√£o**: Container Docker otimizado

#### üñ•Ô∏è Compute Engine VM
- **Fun√ß√£o**: Hospedagem do Redis Cache
- **Benef√≠cios**: Performance dedicada, controle total, persist√™ncia
- **Configura√ß√£o**: VM otimizada para Redis

#### üê≥ Docker
- **Fun√ß√£o**: Containeriza√ß√£o da aplica√ß√£o
- **Benef√≠cios**: Portabilidade, isolamento, deploy consistente
- **Configura√ß√£o**: Multi-stage build para otimiza√ß√£o

### Fluxo de Dados

```
Cliente ‚Üí API Gateway ‚Üí Cloud Run ‚Üí Redis VM
                    ‚Üì
                 SWAPI.info
```

1. **Cliente** faz requisi√ß√£o via API Gateway
2. **API Gateway** valida e roteia para Cloud Run
3. **Cloud Run** verifica cache no Redis VM
4. Se n√£o cached: busca na **SWAPI p√∫blica**
5. **Redis VM** armazena resultado para consultas futuras
6. **Resposta** retorna via API Gateway

## ‚öôÔ∏è Configura√ß√£o de Ambiente

### Vari√°veis de Ambiente

#### Para Desenvolvimento Local:
```bash
# Redis Local
REDIS_URL="redis://localhost:6379"

# JWT Secret Key
JWT_SECRET_KEY=your_secure_secret_key_here

# SWAPI Base URL
SWAPI_BASE_URL="https://swapi.info/api"
```

#### Para Produ√ß√£o GCP:
```bash
# Redis VM (IP interno)
REDIS_URL="redis://10.x.x.x:6379"

# JWT Secret Key (segura)
JWT_SECRET_KEY=your_production_secret_key

# SWAPI Base URL
SWAPI_BASE_URL="https://swapi.info/api"
```

### Gerar Nova JWT Secret Key:
```bash
openssl rand -hex 64
```

## üê≥ Docker & Containeriza√ß√£o

### Desenvolvimento Local:
```bash
# Iniciar Redis local
docker compose up -d

# Verificar status
docker compose ps

# Logs do Redis
docker compose logs redis

# Parar servi√ßos
docker compose down
```

### Build para Produ√ß√£o:
```bash
# Build da imagem
docker build -t starwars-api .

# Run local
docker run -p 8080:8080 starwars-api

# Tag para GCP
docker tag starwars-api gcr.io/YOUR_PROJECT/starwars-api

# Push para Container Registry
docker push gcr.io/YOUR_PROJECT/starwars-api
```

## üß™ Testes & Qualidade

### Executar todos os testes:
```bash
poetry run pytest
```

### Testes espec√≠ficos:
```bash
# Testes de rotas
poetry run pytest tests/test_routes.py -v

# Testes de servi√ßos
poetry run pytest tests/test_swapi_service.py -v

# Testes de autentica√ß√£o
poetry run pytest tests/test_auth_service.py -v

# Testes de utilit√°rios
poetry run pytest tests/test_utils.py -v

# Testes funcionais completos
poetry run pytest tests/test_working.py -v
```

### Cobertura de c√≥digo:
```bash
poetry run pytest --cov=src/starwars_api --cov-report=html
```

## üìö Documenta√ß√£o Interativa

### Swagger UI (Recomendado)
```
https://swapi-gateway-9gaiurpg.uc.gateway.dev/docs
```

### ReDoc (Alternativa)
```
https://swapi-gateway-9gaiurpg.uc.gateway.dev/redoc
```

### Documenta√ß√£o Local (Desenvolvimento)
```
http://localhost:8000/docs
http://localhost:8000/redoc
```

## üåü Funcionalidades Avan√ßadas

### 1. Cache Inteligente Multi-Camada
- **L1**: Cache local em mem√≥ria para consultas frequentes
- **L2**: Redis para persist√™ncia e compartilhamento
- **L3**: Fallback para SWAPI p√∫blica

### 2. Resolu√ß√£o Autom√°tica de URLs
- URLs da SWAPI s√£o transformadas em nomes leg√≠veis
- Sistema de cache espec√≠fico para resolu√ß√£o de nomes
- Fallback gracioso em caso de falha

### 3. Autentica√ß√£o JWT Robusta
- Tokens com expira√ß√£o configur√°vel
- Middleware de valida√ß√£o em todos os endpoints protegidos
- Refresh autom√°tico de tokens

### 4. Filtros Din√¢micos
- Suporte a m√∫ltiplos filtros simult√¢neos
- Filtros por campos aninhados
- Filtros com operadores (igual, cont√©m, maior que, etc.)

### 5. Ordena√ß√£o Inteligente
- Detec√ß√£o autom√°tica de tipos de dados
- Ordena√ß√£o num√©rica para campos num√©ricos
- Ordena√ß√£o lexicogr√°fica para strings
- Suporte a ordena√ß√£o por m√∫ltiplos campos

## üõ†Ô∏è Estrutura T√©cnica do Projeto

```
starwars_api/
‚îú‚îÄ‚îÄ src/starwars_api/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                 # Aplica√ß√£o FastAPI principal
‚îÇ   ‚îú‚îÄ‚îÄ cache/                  # Sistema de cache Redis
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache.py           # Interface do cache
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache_instance.py  # Inst√¢ncia Redis
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ warmup_service.py  # Servi√ßo de warm-up
‚îÇ   ‚îú‚îÄ‚îÄ routes/                 # Rotas da API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_router.py     # Endpoints de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ swapi_router.py    # Endpoints SWAPI
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/               # Data Transfer Objects
‚îÇ   ‚îú‚îÄ‚îÄ services/               # L√≥gica de neg√≥cio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_service.py    # Servi√ßo de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ swapi_service.py   # Servi√ßo SWAPI
‚îÇ   ‚îú‚îÄ‚îÄ util/                   # Utilit√°rios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ naming.py          # Resolu√ß√£o de nomes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sorting.py         # Ordena√ß√£o inteligente
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ resolve_name_fields.py # Resolu√ß√£o de campos
‚îÇ   ‚îî‚îÄ‚îÄ enums/                  # Enumera√ß√µes
‚îÇ       ‚îî‚îÄ‚îÄ order_enum.py      # Enum de ordena√ß√£o
‚îú‚îÄ‚îÄ tests/                      # Testes automatizados
‚îú‚îÄ‚îÄ docker-compose.yml          # Configura√ß√£o Redis local
‚îú‚îÄ‚îÄ Dockerfile                  # Container da aplica√ß√£o
‚îú‚îÄ‚îÄ pyproject.toml             # Configura√ß√£o Poetry
‚îî‚îÄ‚îÄ swagger-api-gateway.yaml   # Configura√ß√£o API Gateway
```

## üö® Troubleshooting

### Redis Connection Issues
```bash
# Verificar se Redis est√° rodando
docker compose ps

# Verificar logs do Redis
docker compose logs redis

# Reiniciar Redis
docker compose restart redis

# Testar conex√£o Redis
redis-cli ping
```

### Authentication Problems
1. **Token Expirado**: Gere um novo token via `POST /auth`
2. **Header Incorreto**: Verifique o formato `Authorization: Bearer <token>`
3. **Token Inv√°lido**: Verifique se o JWT_SECRET_KEY est√° correto

### Cache Not Working
1. **Redis Down**: Verifique se Redis est√° rodando
2. **Wrong URL**: Confirme a vari√°vel `REDIS_URL` no ambiente
3. **Empty Cache**: Use `POST /warm-cache` para popular o cache
4. **Network Issues**: Verifique conectividade com a VM do Redis

### SWAPI Connection Issues
1. **Rate Limiting**: A SWAPI p√∫blica tem rate limits
2. **Network Timeout**: Verifique conectividade com swapi.info
3. **Cache Fallback**: Sistema utiliza cache quando SWAPI n√£o responde

### Cloud Run Issues
1. **Cold Start**: Primeira requisi√ß√£o pode ser lenta
2. **Memory Limits**: Verifique configura√ß√£o de mem√≥ria
3. **Timeout**: Ajuste timeout do Cloud Run se necess√°rio

## üîê Seguran√ßa

### JWT Token Security
- Tokens expiram em 1 hora (configur√°vel)
- Secret key deve ser √∫nica por ambiente
- Nunca exponha a secret key em logs

### API Gateway Security
- Rate limiting configurado
- CORS apropriado para produ√ß√£o
- Logs de auditoria habilitados

### Redis Security
- VM em rede privada
- Firewall configurado
- Sem acesso p√∫blico direto

## üìä Monitoramento

### M√©tricas Dispon√≠veis
- **Health Check**: Status da aplica√ß√£o
- **Redis Performance**: Lat√™ncia e throughput
- **SWAPI Calls**: N√∫mero de chamadas √† API externa
- **Cache Hit Rate**: Efici√™ncia do cache

### Logs Estruturados
- Todas as requisi√ß√µes s√£o logadas
- Erros incluem stack traces
- M√©tricas de performance por endpoint

## üöÄ Performance

### Benchmarks
- **Com Cache**: ~10ms resposta m√©dia
- **Sem Cache**: ~500ms resposta m√©dia
- **Cache Hit Rate**: >95% em uso normal
- **Throughput**: 1000+ req/s com cache

### Otimiza√ß√µes
- Conex√µes HTTP reutilizadas
- Serializa√ß√£o JSON otimizada
- Queries de banco eficientes
- Compress√£o de responses

## üìà Roadmap

### Pr√≥ximas Funcionalidades
- [ ] GraphQL interface
- [ ] Webhook notifications
- [ ] Advanced analytics
- [ ] Multi-region cache
- [ ] Real-time updates

### Melhorias Planejadas
- [ ] Kubernetes deployment
- [ ] Prometheus metrics
- [ ] Distributed tracing
- [ ] Advanced caching strategies

## ü§ù Contribui√ß√£o

### Como Contribuir
1. Fork do reposit√≥rio
2. Crie uma branch para sua feature
3. Implemente com testes
4. Abra Pull Request

### Padr√µes de C√≥digo
- Python: PEP 8
- Testes: pytest
- Documenta√ß√£o: docstrings
- Commits: conventional commits

## üìù Notas Importantes

### Desenvolvimento
- ‚úÖ Arquivo `.env` inclu√≠do para facilitar desenvolvimento
- ‚úÖ JWT Secret Key fornecida apenas para testes
- ‚úÖ Redis configurado para desenvolvimento local

### Produ√ß√£o
- ‚ö†Ô∏è Gere nova JWT Secret Key para produ√ß√£o
- ‚ö†Ô∏è Configure Redis em VM dedicada no GCP
- ‚ö†Ô∏è Habilite HTTPS em todos os endpoints
- ‚ö†Ô∏è Configure rate limiting apropriado

### Licen√ßa
Este projeto est√° sob licen√ßa MIT. Veja o arquivo LICENSE para detalhes.

---

**Constru√≠do com ‚ù§Ô∏è usando FastAPI, Redis, Docker e Google Cloud Platform**
